name: CI

on: [push]

jobs:
    sast_scan:
        name: Run a Bandit SAST scan
        runs-on: ubuntu-latest  

        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Python
              uses: actions/setup-python@v2
              with:
                  python-version: '3.x'
            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install bandit
            - name: Run Bandit SAST scan
              run: |
                  bandit -r . -ll -ii -f json -o bandit-report.json
            - name: Upload Bandit report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: bandit-report
                  path: bandit-report.json
    image_scan:
        name: Build Image And Run Image Scan
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Ensure Docker is available (safe)
              run: |
                # If docker is missing, attempt a minimal install (docker.io) without failing the job
                if ! command -v docker >/dev/null 2>&1; then
                  echo "Docker not found on runner; trying to install docker.io"
                  sudo apt-get update || true
                  sudo apt-get install -y docker.io || true
                fi
                echo "Docker version:"
                docker --version || true
                echo "Check /etc/docker/daemon.json if exists"
                if [ -f /etc/docker/daemon.json ]; then
                  sudo cat /etc/docker/daemon.json || true
                else
                  echo "/etc/docker/daemon.json: not present (not an error)"
                fi
            - name: Build Docker image
              run: |
                  docker build -f Dockerfile -t myapp:latest .
            - name: Build Docker Scout
              run: |
                  curl -fsSL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh -o install-scout.sh
                  sh install-scout.sh

                  echo ${{secrets.REPO_PASSWD}} | docker login -u ${{secrets.REPO_USER}} --password-stdin

                  docker scout quickview
                  docker scout cves




              